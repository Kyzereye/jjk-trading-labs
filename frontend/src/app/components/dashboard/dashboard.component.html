<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>Dashboard</h1>
    <p class="welcome-text">Welcome back, {{ user?.name }}!</p>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading dashboard...</p>
  </div>

  <div *ngIf="!loading" class="dashboard-content">
    
    <!-- Stats Cards Row -->
    <div class="stats-grid">
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>assessment</mat-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ dashboardStats.totalAnalyses }}</div>
            <div class="stat-label">Total Analyses</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon success">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ dashboardStats.bestPerformingStock }}</div>
            <div class="stat-label">Best Performer</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon accent">
            <mat-icon>show_chart</mat-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ formatPercent(dashboardStats.averageWinRate) }}</div>
            <div class="stat-label">Avg Win Rate</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon primary">
            <mat-icon>swap_horiz</mat-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ dashboardStats.totalTrades }}</div>
            <div class="stat-label">Total Trades</div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Trade Tracker - Full Width -->
    <mat-expansion-panel 
      [expanded]="shouldExpandTradeTracker()"
      (opened)="tradeTrackerPanelExpanded = true"
      (closed)="tradeTrackerPanelExpanded = false"
      class="trade-tracker-panel full-width">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>track_changes</mat-icon>
          Trade Tracker
          <span *ngIf="getTradeCount() > 0" class="count-badge">{{ getTradeCount() }}</span>
        </mat-panel-title>
        <mat-panel-description *ngIf="!hasTrades()">
          No trades yet
        </mat-panel-description>
        <div class="panel-actions" *ngIf="!isTradeFormVisible()">
          <button mat-icon-button (click)="showAddTradeForm(); $event.stopPropagation()" 
                  matTooltip="Add New Trade">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </mat-expansion-panel-header>
      
      <div class="panel-content">
        <app-trade-tracker [symbol]="tradeSymbol"></app-trade-tracker>
      </div>
    </mat-expansion-panel>

    <!-- Favorite Stocks Watchlist - Full Width -->
    <mat-expansion-panel 
      [expanded]="favoriteStocks.length > 0"
      class="watchlist-panel full-width">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>star</mat-icon>
          Favorite Stocks Watchlist
          <span *ngIf="favoriteStocks.length > 0" class="count-badge">{{ favoriteStocks.length }}</span>
        </mat-panel-title>
        <mat-panel-description *ngIf="favoriteStocks.length === 0">
          No favorite stocks yet
        </mat-panel-description>
      </mat-expansion-panel-header>
      
      <div class="panel-content">
        <!-- Empty State -->
        <div *ngIf="favoriteStocks.length === 0" class="empty-favorites">
          <mat-icon>star_border</mat-icon>
          <h3>No Favorite Stocks Yet</h3>
        </div>

        <!-- Favorites Table -->
        <mat-table *ngIf="favoriteStocks.length > 0" [dataSource]="favoriteStocks" class="favorites-table">
          <ng-container matColumnDef="symbol">
            <mat-header-cell *matHeaderCellDef>Symbol</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              <strong>{{ stock.symbol }}</strong>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="price">
            <mat-header-cell *matHeaderCellDef>Price</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              {{ stock.latest_price ? formatCurrency(stock.latest_price) : '-' }}
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="ma21">
            <mat-header-cell *matHeaderCellDef>21 MA</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              {{ stock.ma_21 ? formatCurrency(stock.ma_21) : '-' }}
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="ma50">
            <mat-header-cell *matHeaderCellDef>50 MA</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              {{ stock.ma_50 ? formatCurrency(stock.ma_50) : '-' }}
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="lastSignal">
            <mat-header-cell *matHeaderCellDef>Last Signal</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              <span class="signal-badge" 
                    [ngClass]="{
                      'buy-signal': stock.last_signal_color === 'buy',
                      'sell-signal': stock.last_signal_color === 'sell',
                      'alert-badge': stock.last_signal_color === 'alert',
                      'neutral-badge': stock.last_signal_color === 'neutral'
                    }">
                {{ stock.last_signal || '-' }}
              </span>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="status">
            <mat-header-cell *matHeaderCellDef>Market Status</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              <span class="status-text" 
                    [ngClass]="{
                      'status-success': stock.status_color === 'success',
                      'status-warning': stock.status_color === 'warning',
                      'status-info': stock.status_color === 'info',
                      'status-neutral': stock.status_color === 'neutral'
                    }">
                {{ stock.status || 'Loading...' }}
              </span>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="action">
            <mat-header-cell *matHeaderCellDef>Action</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              <button mat-raised-button 
                      color="primary" 
                      size="small"
                      (click)="runQuickAnalysis(stock.symbol)">
                Analyze
              </button>
            </mat-cell>
          </ng-container>

          <mat-header-row *matHeaderRowDef="['symbol', 'price', 'ma21', 'ma50', 'lastSignal', 'status', 'action']"></mat-header-row>
          <mat-row *matRowDef="let row; columns: ['symbol', 'price', 'ma21', 'ma50', 'lastSignal', 'status', 'action'];"></mat-row>
        </mat-table>
      </div>
    </mat-expansion-panel>

    <!-- Main Content Grid -->
    <div class="content-grid">

      <!-- Recent Analyses -->
      <mat-expansion-panel 
        [expanded]="recentAnalyses.length > 0"
        class="recent-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>history</mat-icon>
            Recent Analyses
            <span *ngIf="recentAnalyses.length > 0" class="count-badge">{{ recentAnalyses.length }}</span>
          </mat-panel-title>
          <mat-panel-description *ngIf="recentAnalyses.length === 0">
            No recent analyses yet
          </mat-panel-description>
        </mat-expansion-panel-header>
        
        <div class="panel-content">
          <div *ngIf="recentAnalyses.length === 0" class="empty-state">
            <mat-icon>insights</mat-icon>
            <p>No recent analyses yet</p>
            <button mat-raised-button color="primary" routerLink="/trading">
              Run Your First Analysis
            </button>
          </div>
          
          <div *ngIf="recentAnalyses.length > 0" class="recent-list">
            <div *ngFor="let analysis of recentAnalyses" class="recent-item">
              <div class="recent-symbol">{{ analysis.symbol }}</div>
              <div class="recent-stats">
                <span class="stat" [ngClass]="getChangeClass(analysis.total_return)">
                  {{ formatPercent(analysis.total_return) }}
                </span>
                <span class="stat-label">Return</span>
              </div>
              <div class="recent-stats">
                <span class="stat">{{ formatPercent(analysis.win_rate) }}</span>
                <span class="stat-label">Win Rate</span>
              </div>
              <div class="recent-date">{{ analysis.date | date:'short' }}</div>
            </div>
          </div>
        </div>
      </mat-expansion-panel>

    </div>

    <!-- Quick Actions -->
    <mat-card class="actions-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>flash_on</mat-icon>
          Quick Actions
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="quick-actions">
          <button mat-raised-button color="primary" routerLink="/trading">
            <mat-icon>analytics</mat-icon>
            Run Analysis
          </button>
          <button mat-raised-button color="accent" routerLink="/optimize">
            <mat-icon>tune</mat-icon>
            Optimize Strategy
          </button>
          <button mat-raised-button routerLink="/top-performers">
            <mat-icon>emoji_events</mat-icon>
            View Top Performers
          </button>
          <button mat-raised-button routerLink="/profile">
            <mat-icon>settings</mat-icon>
            Settings
          </button>
        </div>
      </mat-card-content>
    </mat-card>

  </div>
</div>

