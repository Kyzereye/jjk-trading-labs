<div class="dashboard-container">
  <div class="dashboard-header">
    <h1>Dashboard</h1>
    <p class="welcome-text">Welcome back, {{ user?.name }}!</p>
  </div>

  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
    <p>Loading dashboard...</p>
  </div>

  <div *ngIf="!loading" class="dashboard-content">
    
    <!-- Stats Cards Row -->
    <div class="stats-grid">
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon">
            <mat-icon>assessment</mat-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ dashboardStats.totalAnalyses }}</div>
            <div class="stat-label">Total Analyses</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon success">
            <mat-icon>trending_up</mat-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ dashboardStats.bestPerformingStock }}</div>
            <div class="stat-label">Best Performer</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon accent">
            <mat-icon>show_chart</mat-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ formatPercent(dashboardStats.averageWinRate) }}</div>
            <div class="stat-label">Avg Win Rate</div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-icon primary">
            <mat-icon>swap_horiz</mat-icon>
          </div>
          <div class="stat-info">
            <div class="stat-value">{{ dashboardStats.totalTrades }}</div>
            <div class="stat-label">Total Trades</div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Trade Tracker - Full Width -->
    <mat-expansion-panel 
      [expanded]="shouldExpandTradeTracker()"
      (opened)="tradeTrackerPanelExpanded = true"
      (closed)="tradeTrackerPanelExpanded = false"
      class="trade-tracker-panel full-width">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>track_changes</mat-icon>
          Trade Tracker
          <span *ngIf="getTradeCount() > 0" class="count-badge">{{ getTradeCount() }}</span>
        </mat-panel-title>
        <mat-panel-description *ngIf="!hasTrades()">
          No trades yet
        </mat-panel-description>
        <div class="panel-actions" *ngIf="!isTradeFormVisible()">
          <button mat-icon-button (click)="showAddTradeForm(); $event.stopPropagation()" 
                  matTooltip="Add New Trade">
            <mat-icon>add</mat-icon>
          </button>
        </div>
      </mat-expansion-panel-header>
      
      <div class="panel-content">
        <app-trade-tracker [symbol]="tradeSymbol"></app-trade-tracker>
      </div>
    </mat-expansion-panel>

    <!-- Trading Alerts - Full Width -->
    <mat-expansion-panel 
      [expanded]="alerts.length > 0"
      class="alerts-panel full-width">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>notifications_active</mat-icon>
          Trading Alerts
          <span *ngIf="filteredAlerts.length > 0" class="count-badge">{{ filteredAlerts.length }} / {{ alerts.length }}</span>
        </mat-panel-title>
        <mat-panel-description *ngIf="alerts.length === 0">
          No recent alerts
        </mat-panel-description>
      </mat-expansion-panel-header>
      
      <div class="panel-content">
        <!-- Action Bar: Favorite Button + Filter Toggle -->
        <div class="action-bar" *ngIf="!alertsLoading && alerts.length > 0">
          <button mat-raised-button 
                  class="action-btn" 
                  (click)="toggleFavoritesFilter()">
            <mat-icon class="btn-icon">star</mat-icon>
            <span class="btn-text">{{ (showOnlyFavorites ? 'Show All Alerts' : 'Show Favorite Alerts') | uppercase }}</span>
          </button>
          
          <button mat-icon-button (click)="toggleFilters()" matTooltip="{{ showFilters ? 'Hide Filters' : 'Show Filters' }}" class="filter-toggle-btn">
            <mat-icon>{{ showFilters ? 'filter_list' : 'filter_list_off' }}</mat-icon>
          </button>
        </div>
        
        <!-- Filters -->
        <div class="alert-filters" *ngIf="!alertsLoading && alerts.length > 0 && showFilters">
          <div class="filter-row">
            
            <div class="filter-field-group">
              <label>Symbol Search</label>
              <div class="simple-search-field">
              <mat-icon>search</mat-icon>
              <input 
                type="text"
                [formControl]="symbolSearchControl"
                placeholder="Search symbols..."
                style="text-transform: uppercase;"
                [matAutocomplete]="symbolAuto">
              <mat-autocomplete #symbolAuto="matAutocomplete">
                <mat-option *ngFor="let symbol of filteredSymbols$ | async" [value]="symbol">
                  {{ symbol }}
                </mat-option>
              </mat-autocomplete>
            </div>
            </div>
            
            <div class="filter-field-group">
              <label>Time Period</label>
              <div class="simple-select-field">
                <select [(ngModel)]="selectedPeriod" (ngModelChange)="onPeriodChange()">
                  <option value="3days">Last 3 Days</option>
                  <option value="week">Last Week</option>
                  <option value="10days">Last 10 Days</option>
                  <option value="2weeks">Last 2 Weeks</option>
                </select>
              </div>
            </div>
            
            <div class="filter-field-group">
              <label>Day</label>
              <div class="simple-select-field">
                <select [(ngModel)]="selectedDay">
                  <option value="all">All Days</option>
                  <option *ngFor="let day of availableDays" [value]="day">
                    {{ day | date:'MMM d, y' }}
                  </option>
                </select>
              </div>
            </div>
            
            <div class="filter-field-group">
              <label>Direction</label>
              <div class="simple-select-field">
                <select [(ngModel)]="selectedDirection">
                  <option value="all">All</option>
                  <option value="long">Long</option>
                  <option value="short">Short</option>
                </select>
              </div>
            </div>
            
            <div class="filter-field-group">
              <label>Type</label>
              <div class="simple-select-field">
                <select [(ngModel)]="selectedType">
                  <option value="all">All</option>
                  <option value="entry">Entry</option>
                  <option value="exit">Exit</option>
                  <option value="mean_reversion">Mean Reversion</option>
                </select>
              </div>
            </div>
            
            <button mat-icon-button class="filter-reset-btn" (click)="resetFilters()" matTooltip="Reset Filters">
              <mat-icon>refresh</mat-icon>
            </button>
          </div>
        </div>
        
        <!-- Loading State -->
        <div *ngIf="alertsLoading" class="loading-container">
          <mat-spinner diameter="30"></mat-spinner>
          <p>Loading alerts...</p>
        </div>

        <!-- Empty State -->
        <div *ngIf="!alertsLoading && filteredAlerts.length === 0 && alerts.length === 0" class="empty-state">
          <mat-icon>notifications_off</mat-icon>
          <h3>No Recent Alerts</h3>
          <p>No trading signals have been generated in the selected time period.</p>
        </div>
        
        <!-- No Results from Filters -->
        <div *ngIf="!alertsLoading && filteredAlerts.length === 0 && alerts.length > 0" class="empty-state">
          <mat-icon>filter_alt</mat-icon>
          <h3>No Alerts Match Filters</h3>
          <p>Try adjusting your filter settings to see more results.</p>
        </div>

        <!-- Alerts List -->
        <div *ngIf="!alertsLoading && filteredAlerts.length > 0" class="alerts-list">
          <div *ngFor="let dayGroup of groupedAlertsByDate; let last = last">
            <!-- Date header -->
            <div class="date-group-header">
              <h3>{{ dayGroup.date | date:'EEEE, MMMM d' }}</h3>
            </div>
            
            <!-- Alerts for this day -->
            <div *ngFor="let alert of dayGroup.alerts" class="alert-container">
              <div class="alert-item clickable" 
                   [ngClass]="'alert-' + alert.signalType + '-' + alert.signalDirection"
                   (click)="onAlertClick(alert)">
                <div class="alert-icon">
                  <mat-icon *ngIf="alert.signalType === 'entry'">trending_up</mat-icon>
                  <mat-icon *ngIf="alert.signalType === 'exit'">trending_down</mat-icon>
                  <mat-icon *ngIf="alert.signalType === 'mean_reversion'">swap_horiz</mat-icon>
                </div>
                <div class="alert-content">
                  <div class="alert-header">
                    <span class="symbol">{{ alert.symbol }}</span>
                    <span class="signal-type">{{ alert.signalType | titlecase }} {{ alert.signalDirection | titlecase }}</span>
                    <span class="price">${{ alert.price | number:'1.2-2' }}</span>
                  </div>
                  <div class="alert-details">
                    <span *ngIf="alert.ma21Value" class="ma-value">MA21: ${{ alert.ma21Value | number:'1.2-2' }}</span>
                    <span *ngIf="alert.ma50Value" class="ma-value">MA50: ${{ alert.ma50Value | number:'1.2-2' }}</span>
                    <span *ngIf="alert.deviationPercent" class="deviation">{{ alert.deviationPercent | number:'1.1-1' }}% deviation</span>
                  </div>
                  <div class="alert-time">
                    <span *ngIf="alert.signalTime">{{ alert.signalTime }}</span>
                  </div>
                </div>
              </div>
              
              <!-- Expanded Details -->
              <div *ngIf="isExpanded(alert.id)" class="alert-expanded">
                <h4>All Recent Alerts for {{ alert.symbol }}</h4>
                <div class="symbol-alerts-list">
                  <div *ngFor="let symbolAlert of getAlertsForSymbol(alert.symbol)" class="symbol-alert-item">
                    <div class="signal-badge" [ngClass]="symbolAlert.signalType + ' ' + symbolAlert.signalDirection">
                      {{ symbolAlert.signalType | uppercase }} {{ symbolAlert.signalDirection | uppercase }}
                    </div>
                    <span class="alert-date">{{ symbolAlert.signalDate | date:'MMM d, y' }}</span>
                    <span class="alert-price">${{ symbolAlert.price | number:'1.2-2' }}</span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Divider between days (not after the last day) -->
            <mat-divider *ngIf="!last" style="margin: 20px 0;"></mat-divider>
          </div>
        </div>
        
        <!-- Pagination Controls -->
        <div *ngIf="!alertsLoading && filteredAlerts.length > 0" class="pagination-controls">
          <div class="pagination-left">
            <div class="pagination-info">
              Showing {{ currentPage * pageSize + 1 }} - {{ Math.min((currentPage + 1) * pageSize, filteredAlerts.length) }} of {{ filteredAlerts.length }}
            </div>
            
            <div class="simple-select-field">
              <select [(ngModel)]="pageSize" (ngModelChange)="onPageSizeChange($event)">
                <option *ngFor="let size of pageSizeOptions" [value]="size">{{ size }}</option>
              </select>
            </div>
          </div>
          
          <div class="pagination-buttons" *ngIf="filteredAlerts.length > pageSize">
            <button mat-icon-button 
                    (click)="previousPage()" 
                    [disabled]="currentPage === 0">
              <mat-icon>chevron_left</mat-icon>
            </button>
            
            <span class="page-numbers">
              Page {{ currentPage + 1 }} of {{ totalPages }}
            </span>
            
            <button mat-icon-button 
                    (click)="nextPage()" 
                    [disabled]="currentPage >= totalPages - 1">
              <mat-icon>chevron_right</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </mat-expansion-panel>

    <!-- Favorite Stocks Watchlist - Full Width -->
    <mat-expansion-panel 
      [expanded]="favoriteStocks.length > 0"
      class="watchlist-panel full-width">
      <mat-expansion-panel-header>
        <mat-panel-title>
          <mat-icon>star</mat-icon>
          Favorite Stocks Watchlist
          <span *ngIf="favoriteStocks.length > 0" class="count-badge">{{ favoriteStocks.length }}</span>
        </mat-panel-title>
        <mat-panel-description *ngIf="favoriteStocks.length === 0">
          No favorite stocks yet
        </mat-panel-description>
      </mat-expansion-panel-header>
      
      <div class="panel-content">
        <!-- Empty State -->
        <div *ngIf="favoriteStocks.length === 0" class="empty-favorites">
          <mat-icon>star_border</mat-icon>
          <h3>No Favorite Stocks Yet</h3>
        </div>

        <!-- Favorites Table -->
        <mat-table *ngIf="favoriteStocks.length > 0" [dataSource]="favoriteStocks" class="favorites-table">
          <ng-container matColumnDef="symbol">
            <mat-header-cell *matHeaderCellDef>Symbol</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              <strong>{{ stock.symbol }}</strong>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="price">
            <mat-header-cell *matHeaderCellDef>Price</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              {{ stock.latest_price ? formatCurrency(stock.latest_price) : '-' }}
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="ma21">
            <mat-header-cell *matHeaderCellDef>21 MA</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              {{ stock.ma_21 ? formatCurrency(stock.ma_21) : '-' }}
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="ma50">
            <mat-header-cell *matHeaderCellDef>50 MA</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              {{ stock.ma_50 ? formatCurrency(stock.ma_50) : '-' }}
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="lastSignal">
            <mat-header-cell *matHeaderCellDef>Last Signal</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              <span class="signal-badge" 
                    [ngClass]="{
                      'buy-signal': stock.last_signal_color === 'buy',
                      'sell-signal': stock.last_signal_color === 'sell',
                      'alert-badge': stock.last_signal_color === 'alert',
                      'neutral-badge': stock.last_signal_color === 'neutral'
                    }">
                {{ stock.last_signal || '-' }}
              </span>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="status">
            <mat-header-cell *matHeaderCellDef>Market Status</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              <span class="status-text" 
                    [ngClass]="{
                      'status-success': stock.status_color === 'success',
                      'status-warning': stock.status_color === 'warning',
                      'status-info': stock.status_color === 'info',
                      'status-neutral': stock.status_color === 'neutral'
                    }">
                {{ stock.status || 'Loading...' }}
              </span>
            </mat-cell>
          </ng-container>

          <ng-container matColumnDef="action">
            <mat-header-cell *matHeaderCellDef>Action</mat-header-cell>
            <mat-cell *matCellDef="let stock">
              <button mat-raised-button 
                      color="primary" 
                      size="small"
                      (click)="runQuickAnalysis(stock.symbol)">
                Analyze
              </button>
            </mat-cell>
          </ng-container>

          <mat-header-row *matHeaderRowDef="['symbol', 'price', 'ma21', 'ma50', 'lastSignal', 'status', 'action']"></mat-header-row>
          <mat-row *matRowDef="let row; columns: ['symbol', 'price', 'ma21', 'ma50', 'lastSignal', 'status', 'action'];"></mat-row>
        </mat-table>
      </div>
    </mat-expansion-panel>

    <!-- Main Content Grid -->
    <div class="content-grid">

      <!-- Recent Analyses -->
      <mat-expansion-panel 
        [expanded]="recentAnalyses.length > 0"
        class="recent-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>history</mat-icon>
            Recent Analyses
            <span *ngIf="recentAnalyses.length > 0" class="count-badge">{{ recentAnalyses.length }}</span>
          </mat-panel-title>
          <mat-panel-description *ngIf="recentAnalyses.length === 0">
            No recent analyses yet
          </mat-panel-description>
        </mat-expansion-panel-header>
        
        <div class="panel-content">
          <div *ngIf="recentAnalyses.length === 0" class="empty-state">
            <mat-icon>insights</mat-icon>
            <p>No recent analyses yet</p>
            <button mat-raised-button color="primary" routerLink="/trading">
              Run Your First Analysis
            </button>
          </div>
          
          <div *ngIf="recentAnalyses.length > 0" class="recent-list">
            <div *ngFor="let analysis of recentAnalyses" class="recent-item">
              <div class="recent-symbol">{{ analysis.symbol }}</div>
              <div class="recent-stats">
                <span class="stat" [ngClass]="getChangeClass(analysis.total_return)">
                  {{ formatPercent(analysis.total_return) }}
                </span>
                <span class="stat-label">Return</span>
              </div>
              <div class="recent-stats">
                <span class="stat">{{ formatPercent(analysis.win_rate) }}</span>
                <span class="stat-label">Win Rate</span>
              </div>
              <div class="recent-date">{{ analysis.date | date:'short' }}</div>
            </div>
          </div>
        </div>
      </mat-expansion-panel>

    </div>

    <!-- Quick Actions -->
    <mat-card class="actions-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>flash_on</mat-icon>
          Quick Actions
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="quick-actions">
          <button mat-raised-button color="primary" routerLink="/trading">
            <mat-icon>analytics</mat-icon>
            Run Analysis
          </button>
          <button mat-raised-button color="accent" routerLink="/optimize">
            <mat-icon>tune</mat-icon>
            Optimize Strategy
          </button>
          <button mat-raised-button routerLink="/top-performers">
            <mat-icon>emoji_events</mat-icon>
            View Top Performers
          </button>
          <button mat-raised-button routerLink="/profile">
            <mat-icon>settings</mat-icon>
            Settings
          </button>
        </div>
      </mat-card-content>
    </mat-card>

  </div>
</div>

